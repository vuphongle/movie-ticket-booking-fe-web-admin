# Coupon Refactor Deployment Plan

## üöÄ Overview

Successfully refactored coupon system from 2-table to 3-table architecture:
- **Phase 1-2:** ‚úÖ Project preparation and branch setup
- **Phase 3:** ‚úÖ Backend entities and services refactored  
- **Phase 4:** ‚úÖ Frontend types and components updated
- **Phase 5:** ‚ö†Ô∏è  Compilation issues identified (need fixing)
- **Phase 6:** üìã Deployment planning

## üèóÔ∏è Architecture Changes

### Database Schema Changes (Auto-generated by Hibernate)
```sql
-- New table
CREATE TABLE coupon_detail_terms (
    id INT PRIMARY KEY,
    percent DECIMAL(5,2),
    amount DECIMAL(15,2),
    gift_service_id INT,
    gift_quantity INT,
    limit_quantity_applied INT,
    detail_used_count INT DEFAULT 0,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (id) REFERENCES coupon_details(id)
);

-- Modified table
ALTER TABLE coupons 
ADD COLUMN kind VARCHAR(20) NOT NULL DEFAULT 'VOUCHER';
ALTER TABLE coupons 
MODIFY COLUMN code VARCHAR(255) NULL;

-- Remove from coupon_details (will be handled by Hibernate)
-- ALTER TABLE coupon_details DROP COLUMN percent;
-- ALTER TABLE coupon_details DROP COLUMN amount;
-- etc.
```

### Backend Changes
- ‚úÖ New `CouponKind` enum (DISPLAY, VOUCHER)
- ‚úÖ New `CouponDetailTerms` entity with 1:1 relationship
- ‚úÖ Updated `Coupon` entity: added kind field, code nullable
- ‚úÖ Updated `CouponDetail` entity: removed terms fields
- ‚úÖ New `CouponDetailTermsRepository`
- ‚úÖ Updated DTOs and services
- ‚ö†Ô∏è Multiple services still reference old fields (need fixing)

### Frontend Changes  
- ‚úÖ Updated TypeScript types with new interfaces
- ‚úÖ Added `CouponKind` enum to frontend
- ‚úÖ Updated `CouponForm` with kind selector and conditional validation
- ‚úÖ Updated `CouponTable` with Kind column
- ‚úÖ Services automatically use new types via RTK Query

## üîß Remaining Work Before Deployment

### Critical Issues to Fix
1. **Backend Compilation Errors (37 errors)**:
   - Multiple services accessing removed CouponDetail fields
   - Services: CouponPreviewService, RedemptionService, CouponDuplicateValidator
   - Controllers: CouponDetailController  
   - Need to update all usages to access terms via relationship

2. **Missing Backend Implementation**:
   - Complete `TermsData` class in request DTO
   - Fix validation methods in CouponDetailService
   - Update all services to use terms relationship

3. **Frontend Incomplete**:
   - CouponDetailModal needs terms handling
   - Form validation for terms data
   - Display logic for terms in tables

## üìã Deployment Sequence

### Step 1: Fix Compilation Issues
```bash
# Backend - Fix all compilation errors
cd /path/to/backend
./gradlew compileJava
# Fix all 37 errors one by one
```

### Step 2: Database Migration Strategy
Since using `hibernate.ddl-auto=update`:
1. Backup production database
2. Test migration on staging with sample data
3. Deploy backend - Hibernate will auto-create new table and modify existing
4. Verify data integrity post-migration

### Step 3: Deployment Order
1. **Backend first** (breaking changes in API structure)
2. **Frontend second** (depends on new backend API structure)
3. **Data verification** (ensure terms data properly migrated)

### Step 4: Rollback Plan
```sql
-- If issues occur, rollback:
-- 1. Restore database from backup
-- 2. Deploy previous version code
-- 3. Verify system functionality
```

## ‚úÖ Testing Checklist

### Backend Testing
- [ ] All compilation errors fixed
- [ ] Unit tests pass for CouponService
- [ ] Integration tests for CouponDetail CRUD
- [ ] API endpoints return correct structure
- [ ] Database constraints working properly

### Frontend Testing  
- [ ] CouponForm creates VOUCHER with code
- [ ] CouponForm creates DISPLAY without code
- [ ] CouponTable displays kinds correctly
- [ ] CouponDetail forms handle terms data
- [ ] No TypeScript compilation errors

### Integration Testing
- [ ] End-to-end coupon creation flow
- [ ] Coupon code validation by kind
- [ ] Terms data persistence and retrieval
- [ ] Existing coupon data still accessible

## üö® Production Readiness

### Current Status: ‚ùå NOT READY
**Blockers:**
- 37 backend compilation errors
- Missing terms handling in multiple services
- Incomplete frontend forms
- No testing completed

**Estimated time to production ready:** 2-3 additional days

### Next Steps:
1. Fix all compilation errors
2. Complete CouponDetailModal terms handling  
3. Run comprehensive testing
4. Create staging environment testing
5. Prepare rollback procedures

## üìä Success Metrics

### Post-Deployment Verification
- [ ] All existing coupons display correctly
- [ ] Can create VOUCHER coupons with codes
- [ ] Can create DISPLAY coupons without codes
- [ ] Terms data properly separated and accessible
- [ ] No data loss during migration
- [ ] Performance maintained or improved

---

**Branch:** `feature/refactor-coupon-to-3-tables`  
**Status:** In Development - Major Refactor 75% Complete  
**Next Action:** Fix compilation errors before testing phase